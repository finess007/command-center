<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>English Mistakes Practice</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #0a0a0f;
  --surface: rgba(255,255,255,0.03);
  --surface-hover: rgba(255,255,255,0.06);
  --border: rgba(255,255,255,0.08);
  --border-hover: rgba(255,255,255,0.15);
  --text: #fff;
  --text-dim: #6b7280;
  --text-mid: #9ca3af;
  --accent: #a78bfa;
  --accent-glow: rgba(167,139,250,0.15);
  --green: #22c55e;
  --red: #ef4444;
  --yellow: #f59e0b;
  --blue: #3b82f6;
  --cyan: #06b6d4;
  --pink: #ec4899;
  --orange: #f97316;
  --cat-preposition: #3b82f6;
  --cat-word-order: #f59e0b;
  --cat-phrasal-verb: #a78bfa;
  --cat-article: #22c55e;
  --cat-redundancy: #f97316;
  --cat-collocation: #ec4899;
  --cat-verb-form: #06b6d4;
  --cat-other: #6b7280;
}
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: 'Inter', -apple-system, sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}
.bg-gradient {
  position: fixed; inset: 0;
  background:
    radial-gradient(ellipse at 20% 20%, rgba(120,0,255,0.15) 0%, transparent 50%),
    radial-gradient(ellipse at 80% 80%, rgba(0,200,255,0.1) 0%, transparent 50%);
  z-index: -1;
}

/* Layout */
.container { max-width: 1200px; margin: 0 auto; padding: 32px 20px 60px; }
.back-link { display: inline-flex; align-items: center; gap: 6px; color: var(--text-dim); text-decoration: none; font-size: 0.85rem; margin-bottom: 24px; transition: color 0.2s; }
.back-link:hover { color: var(--accent); }

/* Header */
.page-header { text-align: center; margin-bottom: 36px; }
.page-header h1 { font-size: 2.2rem; font-weight: 700; background: linear-gradient(135deg, #fff, #a78bfa, #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 8px; }
.page-header p { color: var(--text-dim); font-size: 0.95rem; }

/* Tabs */
.tabs { display: flex; gap: 4px; margin-bottom: 28px; overflow-x: auto; padding-bottom: 4px; -webkit-overflow-scrolling: touch; }
.tab { padding: 10px 20px; border-radius: 12px; border: 1px solid var(--border); background: var(--surface); color: var(--text-dim); font-size: 0.85rem; font-weight: 500; cursor: pointer; white-space: nowrap; transition: all 0.2s; font-family: inherit; }
.tab:hover { background: var(--surface-hover); color: var(--text); }
.tab.active { background: var(--accent-glow); border-color: rgba(167,139,250,0.3); color: var(--accent); }

/* Panel */
.panel { display: none; }
.panel.active { display: block; }

/* Cards / Widgets */
.card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 16px;
  padding: 24px;
  position: relative;
  overflow: hidden;
}
.card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.08), transparent);
}
.card-title { font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-dim); margin-bottom: 16px; }

/* Stats Grid */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { text-align: center; }
.stat-num { font-size: 2.2rem; font-weight: 800; margin-bottom: 4px; }
.stat-label { font-size: 0.78rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; }

/* Charts Row */
.charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 24px; }
@media (max-width: 700px) { .charts-row { grid-template-columns: 1fr; } }
.chart-container { display: flex; flex-direction: column; align-items: center; }
canvas.chart { max-width: 100%; }

/* Legend */
.legend { display: flex; flex-wrap: wrap; gap: 8px 16px; margin-top: 12px; justify-content: center; }
.legend-item { display: flex; align-items: center; gap: 6px; font-size: 0.78rem; color: var(--text-mid); }
.legend-dot { width: 10px; height: 10px; border-radius: 3px; flex-shrink: 0; }

/* Mistake List */
.filter-bar { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px; align-items: center; }
.filter-bar select, .filter-bar input { background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: var(--text); padding: 8px 12px; border-radius: 10px; font-size: 0.85rem; font-family: inherit; outline: none; }
.filter-bar select:focus, .filter-bar input:focus { border-color: rgba(167,139,250,0.4); }
.filter-bar select option { background: #1a1a2e; }

.mistake-list { max-height: 600px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding-right: 4px; }
.mistake-list::-webkit-scrollbar { width: 6px; }
.mistake-list::-webkit-scrollbar-track { background: transparent; }
.mistake-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }

.mistake-item {
  background: rgba(255,255,255,0.02);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 16px;
  border-left: 3px solid var(--cat-other);
  transition: background 0.2s;
}
.mistake-item:hover { background: rgba(255,255,255,0.04); }
.mistake-item[data-cat="preposition"] { border-left-color: var(--cat-preposition); }
.mistake-item[data-cat="word-order"] { border-left-color: var(--cat-word-order); }
.mistake-item[data-cat="phrasal-verb"] { border-left-color: var(--cat-phrasal-verb); }
.mistake-item[data-cat="article"] { border-left-color: var(--cat-article); }
.mistake-item[data-cat="redundancy"] { border-left-color: var(--cat-redundancy); }
.mistake-item[data-cat="collocation"] { border-left-color: var(--cat-collocation); }
.mistake-item[data-cat="verb-form"] { border-left-color: var(--cat-verb-form); }

.mistake-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
.badge { display: inline-block; padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
.badge-cat { color: #fff; }
.badge-box { background: rgba(255,255,255,0.08); color: var(--text-mid); }
.badge-date { background: none; color: var(--text-dim); font-weight: 400; font-size: 0.75rem; }

.mistake-text { font-size: 0.9rem; line-height: 1.6; }
.mistake-text .orig { color: var(--red); text-decoration: line-through; opacity: 0.8; }
.mistake-text .fix { color: var(--green); font-weight: 500; }
.mistake-text .arrow { color: var(--text-dim); margin: 0 6px; }
.mistake-explain { margin-top: 6px; font-size: 0.8rem; color: var(--text-dim); font-style: italic; }

/* Pattern Analysis */
.trouble-spots { display: grid; gap: 12px; margin-bottom: 24px; }
.trouble-card { display: flex; align-items: center; gap: 16px; padding: 16px; background: rgba(255,255,255,0.02); border: 1px solid var(--border); border-radius: 12px; }
.trouble-rank { font-size: 1.8rem; font-weight: 800; color: var(--accent); min-width: 40px; text-align: center; }
.trouble-info { flex: 1; }
.trouble-name { font-size: 1rem; font-weight: 600; margin-bottom: 4px; text-transform: capitalize; }
.trouble-count { font-size: 0.8rem; color: var(--text-dim); }
.trouble-bar { height: 6px; border-radius: 3px; margin-top: 6px; }

.repeat-offenders { margin-top: 24px; }

/* Quiz */
.quiz-start { text-align: center; padding: 40px 20px; }
.quiz-start p { color: var(--text-dim); margin-bottom: 24px; font-size: 0.95rem; }
.btn {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 12px 28px; border-radius: 12px; border: none;
  font-family: inherit; font-size: 0.95rem; font-weight: 600;
  cursor: pointer; transition: all 0.2s;
}
.btn-primary { background: linear-gradient(135deg, #7c3aed, #a78bfa); color: #fff; }
.btn-primary:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(124,58,237,0.3); }
.btn-secondary { background: rgba(255,255,255,0.06); border: 1px solid var(--border); color: var(--text); }
.btn-secondary:hover { background: rgba(255,255,255,0.1); }
.btn-sm { padding: 8px 16px; font-size: 0.82rem; border-radius: 8px; }

.quiz-area { max-width: 640px; margin: 0 auto; }
.quiz-progress { display: flex; align-items: center; gap: 12px; margin-bottom: 20px; }
.quiz-prog-bar { flex: 1; height: 6px; background: rgba(255,255,255,0.06); border-radius: 3px; overflow: hidden; }
.quiz-prog-fill { height: 100%; background: linear-gradient(90deg, #7c3aed, #a78bfa); border-radius: 3px; transition: width 0.3s; }
.quiz-prog-text { font-size: 0.8rem; color: var(--text-dim); white-space: nowrap; }

.quiz-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  padding: 32px; text-align: center;
}
.quiz-label { font-size: 0.75rem; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.quiz-sentence { font-size: 1.15rem; color: var(--red); margin-bottom: 24px; line-height: 1.6; font-weight: 500; }
.quiz-input {
  width: 100%; padding: 14px 18px; border-radius: 12px;
  background: rgba(255,255,255,0.04); border: 1px solid var(--border);
  color: var(--text); font-size: 1rem; font-family: inherit; outline: none;
  transition: border-color 0.2s;
}
.quiz-input:focus { border-color: rgba(167,139,250,0.4); }
.quiz-input::placeholder { color: rgba(255,255,255,0.2); }
.quiz-actions { display: flex; gap: 10px; margin-top: 16px; justify-content: center; }

.quiz-feedback { margin-top: 20px; padding: 16px; border-radius: 12px; text-align: left; }
.quiz-feedback.correct { background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.2); }
.quiz-feedback.incorrect { background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.2); }
.quiz-feedback .fb-title { font-weight: 600; margin-bottom: 8px; }
.quiz-feedback.correct .fb-title { color: var(--green); }
.quiz-feedback.incorrect .fb-title { color: var(--red); }
.quiz-feedback .fb-text { font-size: 0.88rem; color: var(--text-mid); line-height: 1.5; }

.quiz-results { text-align: center; padding: 20px; }
.quiz-score { font-size: 3.5rem; font-weight: 800; margin: 12px 0 8px; }
.quiz-score.good { color: var(--green); }
.quiz-score.ok { color: var(--yellow); }
.quiz-score.bad { color: var(--red); }

/* Preposition Drills */
.drill-area { max-width: 640px; margin: 0 auto; }
.drill-card {
  background: var(--surface); border: 1px solid var(--border); border-radius: 16px;
  padding: 32px; text-align: center;
}
.drill-sentence { font-size: 1.2rem; margin-bottom: 20px; line-height: 1.6; }
.drill-blank { display: inline-block; min-width: 80px; border-bottom: 2px dashed var(--accent); margin: 0 4px; }
.drill-input {
  width: 120px; padding: 10px 14px; border-radius: 10px; text-align: center;
  background: rgba(255,255,255,0.04); border: 1px solid var(--border);
  color: var(--text); font-size: 1.1rem; font-family: inherit; outline: none;
}
.drill-input:focus { border-color: rgba(167,139,250,0.4); }
.drill-score-bar { display: flex; gap: 8px; justify-content: center; margin: 16px 0; align-items: center; }
.drill-streak { font-size: 0.85rem; color: var(--text-dim); }

/* Import/Export */
.io-bar { display: flex; gap: 10px; margin-top: 24px; justify-content: center; flex-wrap: wrap; }
.io-bar input[type="file"] { display: none; }

/* Responsive */
@media (max-width: 640px) {
  .container { padding: 20px 12px 40px; }
  .page-header h1 { font-size: 1.6rem; }
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .stat-num { font-size: 1.6rem; }
  .quiz-card, .drill-card { padding: 20px; }
  .tabs { gap: 2px; }
  .tab { padding: 8px 14px; font-size: 0.8rem; }
}

/* Animations */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
.fade-in { animation: fadeIn 0.3s ease; }
</style>
</head>
<body>
<div class="bg-gradient"></div>
<div class="container">
  <a href="index.html" class="back-link">‚Üê Back to Command Center</a>
  
  <div class="page-header">
    <h1>üìù English Mistakes Practice</h1>
    <p>Track, review, and drill your real mistakes ‚Ä¢ Leitner spaced repetition</p>
  </div>

  <div class="tabs">
    <button class="tab active" data-tab="stats">üìä Stats</button>
    <button class="tab" data-tab="browser">üìã Browse</button>
    <button class="tab" data-tab="patterns">üîç Patterns</button>
    <button class="tab" data-tab="quiz">üéÆ Quiz</button>
    <button class="tab" data-tab="drills">üéØ Prepositions</button>
  </div>

  <!-- ==================== STATS PANEL ==================== -->
  <div class="panel active" id="panel-stats">
    <div class="stats-grid" id="stats-overview"></div>
    <div class="charts-row">
      <div class="card">
        <div class="card-title">Category Breakdown</div>
        <div class="chart-container">
          <canvas id="chart-categories" class="chart" width="260" height="260"></canvas>
          <div class="legend" id="legend-categories"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-title">Leitner Box Distribution</div>
        <div class="chart-container">
          <canvas id="chart-boxes" class="chart" width="300" height="260"></canvas>
          <div class="legend" id="legend-boxes"></div>
        </div>
      </div>
    </div>
    <div class="io-bar">
      <button class="btn btn-secondary btn-sm" onclick="exportData()">üì§ Export JSON</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('import-file').click()">üì• Import JSON</button>
      <input type="file" id="import-file" accept=".json" onchange="importData(event)">
    </div>
  </div>

  <!-- ==================== BROWSER PANEL ==================== -->
  <div class="panel" id="panel-browser">
    <div class="card">
      <div class="filter-bar">
        <select id="filter-cat" onchange="renderMistakeList()">
          <option value="all">All Categories</option>
          <option value="preposition">Preposition</option>
          <option value="word-order">Word Order</option>
          <option value="phrasal-verb">Phrasal Verb</option>
          <option value="article">Article</option>
          <option value="redundancy">Redundancy</option>
          <option value="collocation">Collocation</option>
          <option value="verb-form">Verb Form</option>
          <option value="other">Other</option>
        </select>
        <select id="sort-by" onchange="renderMistakeList()">
          <option value="date-desc">Newest First</option>
          <option value="date-asc">Oldest First</option>
          <option value="box-asc">Box ‚Üë (Needs Work)</option>
          <option value="box-desc">Box ‚Üì (Mastered)</option>
          <option value="category">Category</option>
        </select>
        <input type="text" id="search-text" placeholder="Search..." oninput="renderMistakeList()" style="flex:1;min-width:120px;">
      </div>
      <div class="mistake-list" id="mistake-list"></div>
    </div>
  </div>

  <!-- ==================== PATTERNS PANEL ==================== -->
  <div class="panel" id="panel-patterns">
    <div class="card" style="margin-bottom:20px;">
      <div class="card-title">üéØ Your Biggest Trouble Spots</div>
      <div class="trouble-spots" id="trouble-spots"></div>
    </div>
    <div class="charts-row">
      <div class="card">
        <div class="card-title">Mistakes per Week</div>
        <canvas id="chart-timeline" class="chart" width="350" height="220"></canvas>
      </div>
      <div class="card">
        <div class="card-title">üîÅ Repeat Offenders</div>
        <div id="repeat-offenders" style="max-height:300px;overflow-y:auto;"></div>
      </div>
    </div>
  </div>

  <!-- ==================== QUIZ PANEL ==================== -->
  <div class="panel" id="panel-quiz">
    <div id="quiz-container">
      <div class="quiz-start card" id="quiz-start">
        <h2 style="font-size:1.5rem;margin-bottom:8px;">Practice Now</h2>
        <p>Mistakes from Box 0 and Box 1 come first (Leitner priority).<br>Type the corrected sentence. Flexible matching ‚Äî just get the key fix right.</p>
        <div style="display:flex;gap:10px;justify-content:center;align-items:center;margin-bottom:20px;flex-wrap:wrap;">
          <span style="color:var(--text-dim);font-size:0.85rem;">Round size:</span>
          <select id="quiz-count" style="background:rgba(255,255,255,0.06);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:8px;font-family:inherit;">
            <option value="5">5 questions</option>
            <option value="10" selected>10 questions</option>
            <option value="0">All available</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="startQuiz()">üöÄ Start Quiz</button>
      </div>
      <div id="quiz-active" style="display:none;" class="quiz-area"></div>
      <div id="quiz-results" style="display:none;" class="quiz-results card"></div>
    </div>
  </div>

  <!-- ==================== PREPOSITIONS PANEL ==================== -->
  <div class="panel" id="panel-drills">
    <div class="drill-area">
      <div class="card" style="margin-bottom:20px;text-align:center;">
        <div class="card-title">üáßüá¨‚Üíüá¨üáß Bulgarian Transfer Errors</div>
        <p style="color:var(--text-dim);font-size:0.88rem;margin-bottom:16px;">Fill in the correct preposition. These are the ones Bulgarian speakers get wrong most.</p>
        <div class="drill-score-bar">
          <span class="drill-streak" id="drill-score">Score: 0/0</span>
          <span style="color:var(--text-dim);font-size:0.75rem;">|</span>
          <span class="drill-streak" id="drill-streak-display">Streak: 0 üî•</span>
        </div>
      </div>
      <div class="drill-card" id="drill-card">
        <div id="drill-content"></div>
        <div style="margin-top:20px;">
          <input type="text" class="drill-input" id="drill-input" placeholder="?" autocomplete="off" autocapitalize="none">
        </div>
        <div style="margin-top:14px;display:flex;gap:10px;justify-content:center;">
          <button class="btn btn-primary btn-sm" id="drill-check-btn" onclick="checkDrill()">Check</button>
          <button class="btn btn-secondary btn-sm" onclick="nextDrill()">Skip ‚Üí</button>
        </div>
        <div id="drill-feedback" style="margin-top:16px;"></div>
      </div>
    </div>
  </div>
</div>

<script>
// ============================================================
//  SEED DATA (embedded from english-mistakes-log.json)
// ============================================================
const SEED_DATA = {
  "mistakes": [
    {"id":1,"date":"2026-02-16","original":"skip to romanian sector","corrected":"switch to the Romanian section","category":"collocation","explanation":"sector = industry/geography, section = part of a report","box":0,"lastReviewed":null},
    {"id":2,"date":"2026-02-16","original":"we created a few improvements for you to do","corrected":"we came up with a few improvements for you to carry out","category":"phrasal-verb","explanation":"come up with = create ideas, carry out = execute tasks","box":0,"lastReviewed":null},
    {"id":3,"date":"2026-02-16","original":"we might not be following them","corrected":"we might not be following through on them","category":"phrasal-verb","explanation":"follow through = complete what was planned","box":0,"lastReviewed":null},
    {"id":4,"date":"2026-02-16","original":"this we already decided last night","corrected":"we already decided on this last night","category":"word-order","explanation":"English: subject before verb. Bulgarian transfer: topic-fronting","box":0,"lastReviewed":null},
    {"id":5,"date":"2026-02-16","original":"most amount of trades","corrected":"most trades","category":"redundancy","explanation":"most amount of = redundant. Just 'most' or 'the highest number of'","box":0,"lastReviewed":null},
    {"id":6,"date":"2026-02-16","original":"probably should wait the agents to finish","corrected":"should probably wait for the agents to finish","category":"preposition","explanation":"wait FOR something (not wait + direct object). Also: adverb placement ‚Äî should probably, not probably should","box":0,"lastReviewed":null},
    {"id":7,"date":"2026-02-16","original":"how to login in midjourney in your browser","corrected":"how to log in to Midjourney on your browser","category":"preposition","explanation":"log in TO a site (not in). ON a browser/device (not in). Also: login=noun, log in=verb","box":0,"lastReviewed":null},
    {"id":8,"date":"2026-02-16","original":"what does it have to say about delivery","corrected":"what should it say about delivery","category":"verb-form","explanation":"have to say = forced/obligated. Should say = what's the right wording","box":0,"lastReviewed":null},
    {"id":9,"date":"2026-02-16","original":"chosen from me products","corrected":"products I've picked out","category":"word-order","explanation":"English: modifier follows noun (products I've chosen). Bulgarian: modifier precedes","box":0,"lastReviewed":null}
  ]
};

const STORAGE_KEY = 'english-mistakes-data';
const CAT_COLORS = {
  preposition: '#3b82f6', 'word-order': '#f59e0b', 'phrasal-verb': '#a78bfa',
  article: '#22c55e', redundancy: '#f97316', collocation: '#ec4899',
  'verb-form': '#06b6d4', other: '#6b7280'
};
const CAT_LABELS = {
  preposition: 'Preposition', 'word-order': 'Word Order', 'phrasal-verb': 'Phrasal Verb',
  article: 'Article', redundancy: 'Redundancy', collocation: 'Collocation',
  'verb-form': 'Verb Form', other: 'Other'
};
const BOX_LABELS = ['Box 0 (New)', 'Box 1', 'Box 2', 'Box 3', 'Box 4 (Mastered)'];
const BOX_COLORS = ['#ef4444', '#f59e0b', '#3b82f6', '#a78bfa', '#22c55e'];

// ============================================================
//  DATA MANAGEMENT
// ============================================================
function loadData() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (raw) {
    try { return JSON.parse(raw); }
    catch(e) { console.error('Parse error', e); }
  }
  // Seed from embedded data
  const data = { mistakes: SEED_DATA.mistakes.map(m => ({...m})), lastPracticed: null, practiceStreak: 0 };
  saveData(data);
  return data;
}
function saveData(data) {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
}
function exportData() {
  const data = loadData();
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = 'english-mistakes-export.json';
  a.click();
}
function importData(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(ev) {
    try {
      const imported = JSON.parse(ev.target.result);
      if (imported.mistakes && Array.isArray(imported.mistakes)) {
        saveData(imported);
        init();
        alert('‚úÖ Data imported successfully!');
      } else {
        alert('‚ùå Invalid format ‚Äî needs a "mistakes" array');
      }
    } catch(err) {
      alert('‚ùå Invalid JSON file');
    }
  };
  reader.readAsText(file);
  e.target.value = '';
}

// ============================================================
//  TABS
// ============================================================
document.querySelectorAll('.tab').forEach(t => {
  t.addEventListener('click', () => {
    document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
    document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
    t.classList.add('active');
    document.getElementById('panel-' + t.dataset.tab).classList.add('active');
  });
});

// ============================================================
//  STATS PANEL
// ============================================================
function renderStats() {
  const data = loadData();
  const m = data.mistakes;
  const total = m.length;
  const cats = {};
  const boxes = [0,0,0,0,0];
  m.forEach(x => {
    cats[x.category] = (cats[x.category]||0) + 1;
    boxes[Math.min(x.box||0, 4)]++;
  });
  const mastered = boxes[3] + boxes[4];
  const streakText = data.practiceStreak || 0;
  const lastP = data.lastPracticed ? new Date(data.lastPracticed).toLocaleDateString() : 'Never';

  document.getElementById('stats-overview').innerHTML = `
    <div class="card stat-card"><div class="stat-num" style="color:#a78bfa;">${total}</div><div class="stat-label">Total Mistakes</div></div>
    <div class="card stat-card"><div class="stat-num" style="color:#ef4444;">${boxes[0]}</div><div class="stat-label">Need Practice</div></div>
    <div class="card stat-card"><div class="stat-num" style="color:#22c55e;">${mastered}</div><div class="stat-label">Mastered</div></div>
    <div class="card stat-card"><div class="stat-num" style="color:#f59e0b;">${streakText}üî•</div><div class="stat-label">Streak</div></div>
  `;

  // Donut chart ‚Äî categories
  drawDonut('chart-categories', cats, CAT_COLORS, CAT_LABELS, 'legend-categories');
  // Bar chart ‚Äî Leitner boxes
  drawBoxBars('chart-boxes', boxes);
}

function drawDonut(canvasId, data, colors, labels, legendId) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  canvas.width = 260 * dpr; canvas.height = 260 * dpr;
  canvas.style.width = '260px'; canvas.style.height = '260px';
  ctx.scale(dpr, dpr);

  const cx = 130, cy = 130, r = 100, inner = 60;
  const entries = Object.entries(data).filter(([,v]) => v > 0).sort((a,b) => b[1]-a[1]);
  const total = entries.reduce((s,[,v]) => s+v, 0);
  if (!total) return;

  let angle = -Math.PI / 2;
  entries.forEach(([cat, count]) => {
    const slice = (count / total) * Math.PI * 2;
    ctx.beginPath();
    ctx.moveTo(cx, cy);
    ctx.arc(cx, cy, r, angle, angle + slice);
    ctx.closePath();
    ctx.fillStyle = colors[cat] || '#6b7280';
    ctx.fill();
    angle += slice;
  });
  // Inner circle
  ctx.beginPath();
  ctx.arc(cx, cy, inner, 0, Math.PI * 2);
  ctx.fillStyle = '#0a0a0f';
  ctx.fill();
  // Center text
  ctx.fillStyle = '#fff';
  ctx.font = 'bold 28px Inter';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(total, cx, cy - 8);
  ctx.font = '11px Inter';
  ctx.fillStyle = '#6b7280';
  ctx.fillText('total', cx, cy + 14);

  // Legend
  const legend = document.getElementById(legendId);
  legend.innerHTML = entries.map(([cat, count]) =>
    `<div class="legend-item"><div class="legend-dot" style="background:${colors[cat]||'#6b7280'}"></div>${labels[cat]||cat} (${count})</div>`
  ).join('');
}

function drawBoxBars(canvasId, boxes) {
  const canvas = document.getElementById(canvasId);
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = 300, h = 260;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);

  const maxVal = Math.max(...boxes, 1);
  const barW = 40, gap = 16, startX = (w - (barW * 5 + gap * 4)) / 2;
  const bottom = h - 40, top = 30, chartH = bottom - top;

  boxes.forEach((val, i) => {
    const x = startX + i * (barW + gap);
    const barH = (val / maxVal) * chartH;
    const y = bottom - barH;

    // Bar
    ctx.fillStyle = BOX_COLORS[i];
    ctx.beginPath();
    ctx.roundRect(x, y, barW, barH, 4);
    ctx.fill();

    // Value on top
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 14px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(val, x + barW/2, y - 8);

    // Label below
    ctx.fillStyle = '#6b7280';
    ctx.font = '11px Inter';
    ctx.fillText('Box ' + i, x + barW/2, bottom + 18);
  });
}

// ============================================================
//  MISTAKE BROWSER
// ============================================================
function renderMistakeList() {
  const data = loadData();
  let items = [...data.mistakes];
  const catFilter = document.getElementById('filter-cat').value;
  const sortBy = document.getElementById('sort-by').value;
  const search = document.getElementById('search-text').value.toLowerCase().trim();

  if (catFilter !== 'all') items = items.filter(m => m.category === catFilter);
  if (search) items = items.filter(m =>
    m.original.toLowerCase().includes(search) ||
    m.corrected.toLowerCase().includes(search) ||
    m.explanation.toLowerCase().includes(search)
  );

  switch(sortBy) {
    case 'date-desc': items.sort((a,b) => b.date.localeCompare(a.date) || b.id - a.id); break;
    case 'date-asc': items.sort((a,b) => a.date.localeCompare(b.date) || a.id - b.id); break;
    case 'box-asc': items.sort((a,b) => (a.box||0) - (b.box||0)); break;
    case 'box-desc': items.sort((a,b) => (b.box||0) - (a.box||0)); break;
    case 'category': items.sort((a,b) => a.category.localeCompare(b.category)); break;
  }

  const list = document.getElementById('mistake-list');
  if (!items.length) {
    list.innerHTML = '<p style="text-align:center;color:var(--text-dim);padding:40px;">No mistakes match your filter.</p>';
    return;
  }
  list.innerHTML = items.map(m => `
    <div class="mistake-item fade-in" data-cat="${m.category}">
      <div class="mistake-meta">
        <span class="badge badge-cat" style="background:${CAT_COLORS[m.category]||'#6b7280'}">${CAT_LABELS[m.category]||m.category}</span>
        <span class="badge badge-box">Box ${m.box||0}</span>
        <span class="badge badge-date">${m.date}</span>
      </div>
      <div class="mistake-text">
        <span class="orig">${esc(m.original)}</span>
        <span class="arrow">‚Üí</span>
        <span class="fix">${esc(m.corrected)}</span>
      </div>
      <div class="mistake-explain">${esc(m.explanation)}</div>
    </div>
  `).join('');
}

function esc(s) { return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

// ============================================================
//  PATTERN ANALYSIS
// ============================================================
function renderPatterns() {
  const data = loadData();
  const m = data.mistakes;

  // Top trouble spots
  const cats = {};
  m.forEach(x => cats[x.category] = (cats[x.category]||0) + 1);
  const sorted = Object.entries(cats).sort((a,b) => b[1]-a[1]);
  const maxCat = sorted[0] ? sorted[0][1] : 1;
  const top3 = sorted.slice(0, 3);

  document.getElementById('trouble-spots').innerHTML = top3.map(([cat, count], i) => `
    <div class="trouble-card fade-in">
      <div class="trouble-rank">#${i+1}</div>
      <div class="trouble-info">
        <div class="trouble-name" style="color:${CAT_COLORS[cat]}">${CAT_LABELS[cat]||cat}</div>
        <div class="trouble-count">${count} mistake${count>1?'s':''} (${Math.round(count/m.length*100)}%)</div>
        <div class="trouble-bar" style="width:${Math.round(count/maxCat*100)}%;background:${CAT_COLORS[cat]}"></div>
      </div>
    </div>
  `).join('');

  // Timeline ‚Äî mistakes per week
  drawTimeline(m);

  // Repeat offenders (box 0 mistakes with lastReviewed ‚Äî they came back)
  const repeats = m.filter(x => (x.box||0) === 0 && x.lastReviewed);
  const offDiv = document.getElementById('repeat-offenders');
  if (!repeats.length) {
    offDiv.innerHTML = '<p style="color:var(--text-dim);font-size:0.85rem;padding:12px;">No repeat offenders yet. Practice more to see which mistakes keep coming back!</p>';
  } else {
    offDiv.innerHTML = repeats.map(r => `
      <div class="mistake-item" data-cat="${r.category}" style="margin-bottom:8px;">
        <div class="mistake-meta">
          <span class="badge badge-cat" style="background:${CAT_COLORS[r.category]||'#6b7280'}">${CAT_LABELS[r.category]||r.category}</span>
          <span class="badge badge-date">Reviewed: ${r.lastReviewed}</span>
        </div>
        <div class="mistake-text"><span class="orig">${esc(r.original)}</span> <span class="arrow">‚Üí</span> <span class="fix">${esc(r.corrected)}</span></div>
      </div>
    `).join('');
  }
}

function drawTimeline(mistakes) {
  const canvas = document.getElementById('chart-timeline');
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const w = 350, h = 220;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);

  // Group by week
  const weeks = {};
  mistakes.forEach(m => {
    const d = new Date(m.date);
    const wk = getWeekKey(d);
    weeks[wk] = (weeks[wk]||0) + 1;
  });
  const wkKeys = Object.keys(weeks).sort();
  if (wkKeys.length === 0) return;

  // Ensure at least 4 weeks of context
  const lastWk = wkKeys[wkKeys.length - 1];
  while (wkKeys.length < 4) {
    const prev = new Date(wkKeys[0]);
    prev.setDate(prev.getDate() - 7);
    const k = getWeekKey(prev);
    wkKeys.unshift(k);
    weeks[k] = 0;
  }

  const vals = wkKeys.map(k => weeks[k] || 0);
  const maxVal = Math.max(...vals, 1);
  const padding = { top: 20, right: 20, bottom: 40, left: 40 };
  const chartW = w - padding.left - padding.right;
  const chartH = h - padding.top - padding.bottom;

  // Grid lines
  ctx.strokeStyle = 'rgba(255,255,255,0.05)';
  ctx.lineWidth = 1;
  for (let i = 0; i <= 4; i++) {
    const y = padding.top + (chartH / 4) * i;
    ctx.beginPath(); ctx.moveTo(padding.left, y); ctx.lineTo(w - padding.right, y); ctx.stroke();
  }

  // Bars
  const barW = Math.min(36, chartW / vals.length - 8);
  vals.forEach((v, i) => {
    const x = padding.left + (chartW / vals.length) * i + (chartW / vals.length - barW) / 2;
    const barH = (v / maxVal) * chartH;
    const y = padding.top + chartH - barH;

    ctx.fillStyle = v > 0 ? '#a78bfa' : 'rgba(255,255,255,0.05)';
    ctx.beginPath();
    ctx.roundRect(x, y, barW, barH || 2, 3);
    ctx.fill();

    // Value
    if (v > 0) {
      ctx.fillStyle = '#fff';
      ctx.font = 'bold 11px Inter';
      ctx.textAlign = 'center';
      ctx.fillText(v, x + barW/2, y - 6);
    }

    // Week label
    ctx.fillStyle = '#6b7280';
    ctx.font = '10px Inter';
    ctx.textAlign = 'center';
    ctx.fillText(formatWeek(wkKeys[i]), x + barW/2, h - padding.bottom + 18);
  });
}

function getWeekKey(d) {
  const jan1 = new Date(d.getFullYear(), 0, 1);
  const dayOfYear = Math.ceil((d - jan1) / 86400000);
  const weekNum = Math.ceil((dayOfYear + jan1.getDay()) / 7);
  return `${d.getFullYear()}-W${String(weekNum).padStart(2,'0')}`;
}
function formatWeek(wk) {
  const [y, w] = wk.split('-W');
  return `W${parseInt(w)}`;
}

// ============================================================
//  QUIZ MODE
// ============================================================
let quizState = null;

function startQuiz() {
  const data = loadData();
  let pool = [...data.mistakes];
  // Leitner priority: box 0 first, then box 1, then rest
  pool.sort((a,b) => (a.box||0) - (b.box||0));

  const count = parseInt(document.getElementById('quiz-count').value) || pool.length;
  pool = pool.slice(0, count || pool.length);

  if (!pool.length) {
    alert('No mistakes to practice!');
    return;
  }

  // Shuffle within priority groups for variety
  shuffleArray(pool);
  // Re-sort to keep box priority but with randomness within groups
  pool.sort((a,b) => (a.box||0) - (b.box||0));
  if (count > 0) pool = pool.slice(0, count);

  quizState = { questions: pool, current: 0, correct: 0, answered: false };
  document.getElementById('quiz-start').style.display = 'none';
  document.getElementById('quiz-results').style.display = 'none';
  document.getElementById('quiz-active').style.display = 'block';
  showQuizQuestion();
}

function showQuizQuestion() {
  const q = quizState.questions[quizState.current];
  const total = quizState.questions.length;
  const pct = ((quizState.current) / total * 100);

  const el = document.getElementById('quiz-active');
  el.innerHTML = `
    <div class="quiz-progress">
      <div class="quiz-prog-bar"><div class="quiz-prog-fill" style="width:${pct}%"></div></div>
      <div class="quiz-prog-text">${quizState.current + 1}/${total}</div>
    </div>
    <div class="quiz-card fade-in">
      <div class="quiz-label">Fix this sentence</div>
      <div class="quiz-sentence">"${esc(q.original)}"</div>
      <input type="text" class="quiz-input" id="quiz-answer" placeholder="Type the corrected version..." autocomplete="off">
      <div class="quiz-actions">
        <button class="btn btn-primary" id="quiz-submit-btn" onclick="submitQuizAnswer()">Check ‚úì</button>
        <button class="btn btn-secondary btn-sm" onclick="skipQuiz()">Show Answer</button>
      </div>
      <div id="quiz-feedback-area"></div>
    </div>
  `;
  quizState.answered = false;
  const inp = document.getElementById('quiz-answer');
  inp.focus();
  inp.addEventListener('keydown', e => { if (e.key === 'Enter' && !quizState.answered) submitQuizAnswer(); });
}

function submitQuizAnswer() {
  if (quizState.answered) { nextQuizQuestion(); return; }
  quizState.answered = true;

  const q = quizState.questions[quizState.current];
  const answer = document.getElementById('quiz-answer').value.trim();
  const isCorrect = checkAnswer(answer, q.corrected, q.original);

  // Update box level
  const data = loadData();
  const mi = data.mistakes.find(m => m.id === q.id);
  if (mi) {
    if (isCorrect) {
      mi.box = Math.min((mi.box||0) + 1, 4);
      quizState.correct++;
    } else {
      mi.box = 0;
    }
    mi.lastReviewed = new Date().toISOString().split('T')[0];
    data.lastPracticed = new Date().toISOString().split('T')[0];
    // Update streak
    const today = new Date().toISOString().split('T')[0];
    if (data._lastStreakDate !== today) {
      data.practiceStreak = (data.practiceStreak || 0) + 1;
      data._lastStreakDate = today;
    }
    saveData(data);
  }

  const fb = document.getElementById('quiz-feedback-area');
  fb.innerHTML = `
    <div class="quiz-feedback ${isCorrect ? 'correct' : 'incorrect'} fade-in">
      <div class="fb-title">${isCorrect ? '‚úÖ Correct!' : '‚ùå Not quite'}</div>
      <div class="fb-text">
        <strong>Expected:</strong> ${esc(q.corrected)}<br>
        <strong>Why:</strong> ${esc(q.explanation)}${isCorrect ? '<br>üì¶ Box ' + (mi ? mi.box : '?') : '<br>üì¶ Back to Box 0'}
      </div>
    </div>
  `;
  document.getElementById('quiz-submit-btn').textContent = 'Next ‚Üí';
}

function skipQuiz() {
  if (quizState.answered) { nextQuizQuestion(); return; }
  // Mark as incorrect (show answer)
  quizState.answered = true;
  const q = quizState.questions[quizState.current];
  const data = loadData();
  const mi = data.mistakes.find(m => m.id === q.id);
  if (mi) {
    mi.box = 0;
    mi.lastReviewed = new Date().toISOString().split('T')[0];
    saveData(data);
  }
  const fb = document.getElementById('quiz-feedback-area');
  fb.innerHTML = `
    <div class="quiz-feedback incorrect fade-in">
      <div class="fb-title">üí° Answer Revealed</div>
      <div class="fb-text">
        <strong>Correct:</strong> ${esc(q.corrected)}<br>
        <strong>Why:</strong> ${esc(q.explanation)}<br>üì¶ Back to Box 0
      </div>
    </div>
  `;
  document.getElementById('quiz-submit-btn').textContent = 'Next ‚Üí';
}

function nextQuizQuestion() {
  quizState.current++;
  if (quizState.current >= quizState.questions.length) {
    showQuizResults();
  } else {
    showQuizQuestion();
  }
}

function checkAnswer(answer, expected, original) {
  if (!answer) return false;
  const norm = s => s.toLowerCase().replace(/[^a-z0-9\s]/g, '').replace(/\s+/g, ' ').trim();
  const a = norm(answer);
  const e = norm(expected);

  // Exact match
  if (a === e) return true;

  // Contains all key words from the correction (flexible)
  // Find words in expected that aren't in original ‚Äî those are the key fixes
  const origWords = new Set(norm(original).split(' '));
  const expWords = e.split(' ');
  const keyFixes = expWords.filter(w => !origWords.has(w) && w.length > 1);

  if (keyFixes.length === 0) return a === e;

  // Check if answer contains most key fix words (>= 70%)
  const found = keyFixes.filter(w => a.includes(w));
  return found.length >= Math.ceil(keyFixes.length * 0.7);
}

function showQuizResults() {
  document.getElementById('quiz-active').style.display = 'none';
  const total = quizState.questions.length;
  const correct = quizState.correct;
  const pct = Math.round(correct / total * 100);
  const grade = pct >= 80 ? 'good' : pct >= 50 ? 'ok' : 'bad';
  const emoji = pct >= 80 ? 'üéâ' : pct >= 50 ? 'üëç' : 'üí™';

  document.getElementById('quiz-results').style.display = 'block';
  document.getElementById('quiz-results').innerHTML = `
    <h2 style="font-size:1.3rem;">${emoji} Round Complete!</h2>
    <div class="quiz-score ${grade}">${correct}/${total}</div>
    <p style="color:var(--text-dim);margin-bottom:8px;">${pct}% correct</p>
    <p style="color:var(--text-dim);font-size:0.85rem;margin-bottom:20px;">
      ${pct >= 80 ? 'Excellent! Keep it up!' : pct >= 50 ? 'Good progress. Practice the ones you missed.' : 'Keep practicing! Focus on the corrections.'}
    </p>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
      <button class="btn btn-primary" onclick="startQuiz()">üîÑ Play Again</button>
      <button class="btn btn-secondary" onclick="backToQuizStart()">‚Üê Back</button>
    </div>
  `;
}

function backToQuizStart() {
  document.getElementById('quiz-active').style.display = 'none';
  document.getElementById('quiz-results').style.display = 'none';
  document.getElementById('quiz-start').style.display = 'block';
}

function shuffleArray(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
}

// ============================================================
//  PREPOSITION DRILLS
// ============================================================
const PREP_DRILLS = [
  { sentence: "I'm waiting ___ the bus.", answer: "for", hint: "—á–∞–∫–∞–º (wait ???)" },
  { sentence: "She depends ___ her parents.", answer: "on", hint: "–∑–∞–≤–∏—Å–∏ –æ—Ç (depends ???)" },
  { sentence: "He's interested ___ art.", answer: "in", hint: "–∏–Ω—Ç–µ—Ä–µ—Å—É–≤–∞–º —Å–µ –æ—Ç (interested ???)" },
  { sentence: "She's married ___ a doctor.", answer: "to", hint: "–∂–µ–Ω–µ–Ω –∑–∞ (married ???)" },
  { sentence: "This consists ___ three parts.", answer: "of", hint: "—Å—ä—Å—Ç–æ–∏ —Å–µ –æ—Ç (consists ???)" },
  { sentence: "I need to log in ___ my account.", answer: "to", hint: "–≤–ª–∏–∑–∞–º –≤ (log in ???)" },
  { sentence: "Open it ___ your browser.", answer: "on", hint: "–Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∞ (??? your browser)" },
  { sentence: "He apologized ___ being late.", answer: "for", hint: "–∏–∑–≤–∏–Ω—è–≤–∞–º —Å–µ –∑–∞ (apologize ???)" },
  { sentence: "I'm satisfied ___ the results.", answer: "with", hint: "–¥–æ–≤–æ–ª–µ–Ω –æ—Ç (satisfied ???)" },
  { sentence: "Don't complain ___ the weather.", answer: "about", hint: "–æ–ø–ª–∞–∫–≤–∞–º —Å–µ –æ—Ç (complain ???)" },
  { sentence: "She concentrates ___ her work.", answer: "on", hint: "–∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∏—Ä–∞–º —Å–µ –≤—ä—Ä—Ö—É (concentrate ???)" },
  { sentence: "He insists ___ paying.", answer: "on", hint: "–Ω–∞—Å—Ç–æ—è–≤–∞–º –∑–∞ (insist ???)" },
  { sentence: "I dream ___ traveling.", answer: "about", hint: "–º–µ—á—Ç–∞—è –∑–∞ (dream ???)" },
  { sentence: "Let me think ___ it.", answer: "about", hint: "–º–∏—Å–ª—è –∑–∞ (think ???)" },
  { sentence: "She succeeded ___ passing.", answer: "in", hint: "—É—Å–ø—è–≤–∞–º –≤ (succeed ???)" },
  { sentence: "He participated ___ the event.", answer: "in", hint: "—É—á–∞—Å—Ç–≤–∞–º –≤ (participate ???)" },
  { sentence: "The result ___ the test was good.", answer: "of", hint: "—Ä–µ–∑—É–ª—Ç–∞—Ç –æ—Ç (result ???)" },
  { sentence: "This is different ___ what I expected.", answer: "from", hint: "—Ä–∞–∑–ª–∏—á–µ–Ω –æ—Ç (different ???)" },
  { sentence: "Listen ___ this song.", answer: "to", hint: "—Å–ª—É—à–∞–º (listen ???)" },
  { sentence: "I'm looking ___ my keys.", answer: "for", hint: "—Ç—ä—Ä—Å—è (look ???)" },
  { sentence: "She arrived ___ the airport.", answer: "at", hint: "–ø—Ä–∏—Å—Ç–∏–≥–∞–º –Ω–∞ (arrive ???)" },
  { sentence: "We arrived ___ Sofia.", answer: "in", hint: "–ø—Ä–∏—Å—Ç–∏–≥–∞–º –≤ (arrive ???)" },
  { sentence: "He's ___ the phone right now.", answer: "on", hint: "–Ω–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ (??? the phone)" },
  { sentence: "I saw it ___ the news.", answer: "on", hint: "–ø–æ –Ω–æ–≤–∏–Ω–∏—Ç–µ (??? the news)" },
  { sentence: "She asked ___ help.", answer: "for", hint: "–º–æ–ª—è –∑–∞ (ask ???)" },
  { sentence: "We need to pay ___ the tickets.", answer: "for", hint: "–ø–ª–∞—â–∞–º –∑–∞ (pay ???)" },
  { sentence: "I'll meet you ___ 3 PM.", answer: "at", hint: "–≤ 3 —á–∞—Å–∞ (??? 3 PM)" },
  { sentence: "The meeting is ___ Monday.", answer: "on", hint: "–≤ –ø–æ–Ω–µ–¥–µ–ª–Ω–∏–∫ (??? Monday)" },
  { sentence: "I was born ___ 1990.", answer: "in", hint: "–ø—Ä–µ–∑ 1990 (??? 1990)" },
  { sentence: "It's ___ the settings menu.", answer: "in", hint: "–≤ –º–µ–Ω—é—Ç–æ (??? the settings)" },
];

let drillState = { current: 0, correct: 0, total: 0, streak: 0, order: [] };

function initDrills() {
  drillState.order = [...Array(PREP_DRILLS.length).keys()];
  shuffleArray(drillState.order);
  drillState.current = 0;
  drillState.correct = 0;
  drillState.total = 0;
  drillState.streak = 0;
  showDrill();
}

function showDrill() {
  if (drillState.current >= drillState.order.length) {
    shuffleArray(drillState.order);
    drillState.current = 0;
  }
  const drill = PREP_DRILLS[drillState.order[drillState.current]];
  const parts = drill.sentence.split('___');
  document.getElementById('drill-content').innerHTML = `
    <div class="drill-sentence">${esc(parts[0])}<span class="drill-blank"></span>${esc(parts[1] || '')}</div>
    <div style="font-size:0.8rem;color:var(--text-dim);margin-top:4px;">üí° ${esc(drill.hint)}</div>
  `;
  document.getElementById('drill-input').value = '';
  document.getElementById('drill-feedback').innerHTML = '';
  document.getElementById('drill-input').focus();
  updateDrillScore();
}

function checkDrill() {
  const drill = PREP_DRILLS[drillState.order[drillState.current]];
  const answer = document.getElementById('drill-input').value.trim().toLowerCase();
  if (!answer) return;

  drillState.total++;
  const correct = answer === drill.answer.toLowerCase();
  if (correct) {
    drillState.correct++;
    drillState.streak++;
  } else {
    drillState.streak = 0;
  }

  document.getElementById('drill-feedback').innerHTML = `
    <div class="quiz-feedback ${correct ? 'correct' : 'incorrect'} fade-in" style="text-align:left;">
      <div class="fb-title">${correct ? '‚úÖ Correct!' : '‚ùå Wrong'}</div>
      <div class="fb-text">${correct ? 'Nice one!' : `The answer is: <strong>${drill.answer}</strong>`}</div>
    </div>
  `;
  updateDrillScore();

  setTimeout(() => nextDrill(), correct ? 1000 : 2000);
}

function nextDrill() {
  drillState.current++;
  showDrill();
}

function updateDrillScore() {
  document.getElementById('drill-score').textContent = `Score: ${drillState.correct}/${drillState.total}`;
  document.getElementById('drill-streak-display').textContent = `Streak: ${drillState.streak} üî•`;
}

// Keyboard shortcut for drills
document.getElementById('drill-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') checkDrill();
});

// ============================================================
//  INIT
// ============================================================
function init() {
  renderStats();
  renderMistakeList();
  renderPatterns();
  initDrills();
}

// CanvasRenderingContext2D.roundRect polyfill
if (!CanvasRenderingContext2D.prototype.roundRect) {
  CanvasRenderingContext2D.prototype.roundRect = function(x, y, w, h, r) {
    if (typeof r === 'number') r = [r,r,r,r];
    this.moveTo(x + r[0], y);
    this.lineTo(x + w - r[1], y);
    this.quadraticCurveTo(x + w, y, x + w, y + r[1]);
    this.lineTo(x + w, y + h - r[2]);
    this.quadraticCurveTo(x + w, y + h, x + w - r[2], y + h);
    this.lineTo(x + r[3], y + h);
    this.quadraticCurveTo(x, y + h, x, y + h - r[3]);
    this.lineTo(x, y + r[0]);
    this.quadraticCurveTo(x, y, x + r[0], y);
    this.closePath();
  };
}

init();
</script>
</body>
</html>
