<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üî¨ Pivot Detection Lab</title>
<style>
:root {
  --bg: #0a0e17; --surface: #131a2b; --surface2: #1a2332;
  --border: #1e2d42; --text: #e2e8f0; --dim: #8892a8;
  --gold: #f6c744; --green: #22c55e; --red: #ef4444;
  --cyan: #06b6d4; --purple: #a855f7; --blue: #3b82f6;
  --orange: #f97316;
}
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
.header { padding: 20px 24px 0; }
.header h1 { font-size: 1.6rem; margin-bottom: 4px; }
.header .sub { color: var(--dim); font-size: 0.85rem; }
.tabs { display: flex; gap: 0; padding: 16px 24px 0; border-bottom: 1px solid var(--border); }
.tab { padding: 10px 20px; cursor: pointer; color: var(--dim); font-size: 0.9rem; border-bottom: 2px solid transparent; transition: all 0.2s; }
.tab:hover { color: var(--text); }
.tab.active { color: var(--gold); border-bottom-color: var(--gold); }
.content { padding: 20px 24px; }
.panel { display: none; }
.panel.active { display: block; }

/* Cards */
.card { background: var(--surface); border: 1px solid var(--border); border-radius: 10px; padding: 18px; margin-bottom: 16px; }
.card h3 { font-size: 1rem; margin-bottom: 12px; color: var(--gold); }

/* Stats row */
.stats-row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 16px; }
.stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px 18px; flex: 1; min-width: 140px; }
.stat-card .value { font-size: 1.5rem; font-weight: 700; }
.stat-card .label { font-size: 0.75rem; color: var(--dim); margin-top: 2px; }

/* Table */
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th { text-align: left; padding: 8px 10px; color: var(--dim); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); cursor: pointer; user-select: none; }
th:hover { color: var(--gold); }
td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
tr:hover { background: rgba(246,199,68,0.05); }
tr.champion { background: rgba(246,199,68,0.1); }
.badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
.badge-gold { background: rgba(246,199,68,0.2); color: var(--gold); }
.badge-green { background: rgba(34,197,94,0.2); color: var(--green); }
.badge-red { background: rgba(239,68,68,0.2); color: var(--red); }
.badge-blue { background: rgba(59,130,246,0.2); color: var(--blue); }
.badge-cyan { background: rgba(6,182,212,0.2); color: var(--cyan); }

/* Heatmap */
.heatmap-grid { display: grid; gap: 4px; margin-top: 10px; }
.hm-cell { padding: 10px 6px; text-align: center; border-radius: 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: transform 0.15s; }
.hm-cell:hover { transform: scale(1.08); z-index: 1; }
.hm-label { padding: 10px 6px; text-align: center; font-size: 0.75rem; color: var(--dim); font-weight: 600; }

/* Trade comparison */
.trade-nav { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
.trade-nav button { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; }
.trade-nav button:hover { border-color: var(--gold); }
.trade-info { font-size: 0.9rem; color: var(--dim); }
.trade-info strong { color: var(--text); }
.bar-chart { margin-top: 10px; }
.bar-row { display: flex; align-items: center; margin-bottom: 4px; }
.bar-label { width: 110px; font-size: 0.75rem; color: var(--dim); flex-shrink: 0; }
.bar-track { flex: 1; height: 22px; background: var(--surface2); border-radius: 4px; overflow: hidden; position: relative; }
.bar-fill { height: 100%; border-radius: 4px; transition: width 0.3s; display: flex; align-items: center; justify-content: flex-end; padding-right: 6px; font-size: 0.7rem; font-weight: 600; }
.bar-value { width: 60px; text-align: right; font-size: 0.8rem; flex-shrink: 0; margin-left: 8px; }

/* Phase roadmap */
.phase-timeline { position: relative; padding-left: 30px; }
.phase-item { position: relative; padding-bottom: 28px; }
.phase-item:last-child { padding-bottom: 0; }
.phase-item::before { content: ''; position: absolute; left: -22px; top: 8px; width: 2px; height: calc(100%); background: var(--border); }
.phase-item:last-child::before { display: none; }
.phase-dot { position: absolute; left: -28px; top: 4px; width: 14px; height: 14px; border-radius: 50%; border: 2px solid var(--border); background: var(--bg); }
.phase-dot.done { background: var(--green); border-color: var(--green); }
.phase-dot.now { background: var(--gold); border-color: var(--gold); animation: pulse 1.5s infinite; }
.phase-dot.queued { background: var(--surface); }
@keyframes pulse { 0%,100% { box-shadow: 0 0 0 0 rgba(246,199,68,0.4); } 50% { box-shadow: 0 0 0 6px rgba(246,199,68,0); } }
.phase-name { font-weight: 600; font-size: 0.95rem; }
.phase-desc { color: var(--dim); font-size: 0.8rem; margin-top: 2px; }
.phase-expected { font-size: 0.75rem; color: var(--cyan); margin-top: 4px; }

/* Council */
.council-card { background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px; margin-bottom: 10px; }
.council-model { font-weight: 600; color: var(--cyan); margin-bottom: 4px; }
.council-core { font-size: 0.85rem; margin-bottom: 4px; }
.council-unique { font-size: 0.8rem; color: var(--dim); }

/* Legend */
.legend { display: flex; gap: 16px; flex-wrap: wrap; margin: 10px 0; font-size: 0.8rem; }
.legend-item { display: flex; align-items: center; gap: 6px; }
.legend-dot { width: 10px; height: 10px; border-radius: 2px; }

/* Responsive */
@media (max-width: 768px) {
  .stats-row { flex-direction: column; }
  .stat-card { min-width: auto; }
  table { font-size: 0.75rem; }
  .header h1 { font-size: 1.3rem; }
}
</style>
</head>
<body>

<div class="header">
  <h1>üî¨ Pivot Detection Lab</h1>
  <div class="sub">Dual-Detector Grid Search ‚Ä¢ 41 Review Trades ‚Ä¢ Phase 1-4 Testing</div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="leaderboard">üèÜ Leaderboard</div>
  <div class="tab" data-tab="heatmap">üó∫Ô∏è Heatmap</div>
  <div class="tab" data-tab="trades">üîç Per-Trade</div>
  <div class="tab" data-tab="roadmap">üõ§Ô∏è Roadmap</div>
  <div class="tab" data-tab="council">ü§ñ AI Council</div>
</div>

<div class="content">
  <!-- LEADERBOARD -->
  <div class="panel active" id="leaderboard">
    <div class="stats-row" id="topStats"></div>
    <div class="card">
      <h3>All Configurations ‚Äî Ranked by ‚â§$50 Accuracy</h3>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--gold)"></div> Dual-detector (hier)</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--cyan)"></div> Single-detector (SM)</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--purple)"></div> SM Champion (best-of-10)</div>
      </div>
      <table id="leaderTable">
        <thead>
          <tr>
            <th data-sort="rank">#</th>
            <th data-sort="label">Config</th>
            <th data-sort="type">Type</th>
            <th data-sort="within50">‚â§$50 ‚Üì</th>
            <th data-sort="within200">‚â§$200</th>
            <th data-sort="within500">‚â§$500</th>
            <th data-sort="avgDiff">Avg Diff</th>
            <th>Accuracy</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- HEATMAP -->
  <div class="panel" id="heatmap">
    <div class="card">
      <h3>Coarse √ó Meso Accuracy Heatmap</h3>
      <div class="sub" style="color:var(--dim); font-size:0.8rem; margin-bottom:6px;">Cell value = trades within $50 of real TOP/BOTTOM. Brighter = better.</div>
      <div style="display:flex; gap: 20px; margin-top: 6px; margin-bottom: 10px;">
        <label style="font-size:0.8rem; color:var(--dim);">
          <input type="radio" name="hmMetric" value="within50" checked> ‚â§$50
        </label>
        <label style="font-size:0.8rem; color:var(--dim);">
          <input type="radio" name="hmMetric" value="within200"> ‚â§$200
        </label>
        <label style="font-size:0.8rem; color:var(--dim);">
          <input type="radio" name="hmMetric" value="avgDiff"> Avg Diff
        </label>
      </div>
      <div id="heatmapGrid"></div>
    </div>
    <div class="card">
      <h3>Key Observations</h3>
      <div id="heatmapInsights" style="font-size:0.85rem; color:var(--dim); line-height:1.6;"></div>
    </div>
  </div>

  <!-- PER-TRADE -->
  <div class="panel" id="trades">
    <div class="trade-nav">
      <button id="prevTrade">‚óÄ Prev</button>
      <span class="trade-info" id="tradeInfo">Trade 1/41</span>
      <button id="nextTrade">Next ‚ñ∂</button>
      <select id="tradePicker" style="background:var(--surface2); border:1px solid var(--border); color:var(--text); padding:6px; border-radius:6px; font-size:0.8rem;"></select>
    </div>
    <div class="stats-row" id="tradeStats"></div>
    <div class="card">
      <h3 id="tradeTitle">Config Comparison</h3>
      <div class="bar-chart" id="tradeBarChart"></div>
    </div>
    <div class="card">
      <h3>All Configs for This Trade</h3>
      <table id="tradeTable">
        <thead>
          <tr>
            <th>Config</th>
            <th>Detected Price</th>
            <th>Diff from Real</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ROADMAP -->
  <div class="panel" id="roadmap">
    <div class="stats-row" id="roadmapStats"></div>
    <div class="card">
      <h3>Phase Roadmap ‚Üí PF 2.0</h3>
      <div class="phase-timeline" id="phaseTimeline"></div>
    </div>
    <div class="card">
      <h3>Test Results History</h3>
      <table>
        <thead><tr><th>Test</th><th>Method</th><th>‚â§$50</th><th>‚â§$200</th><th>Avg Diff</th><th>Verdict</th></tr></thead>
        <tbody id="resultsHistory"></tbody>
      </table>
    </div>
  </div>

  <!-- AI COUNCIL -->
  <div class="panel" id="council">
    <div class="card">
      <h3>ü§ñ AI Council Round 2 ‚Äî Consensus & Disagreements</h3>
      <div style="background:rgba(34,197,94,0.1); border:1px solid rgba(34,197,94,0.3); border-radius:8px; padding:12px; margin-bottom:16px;">
        <div style="font-weight:600; color:var(--green); margin-bottom:4px;">‚úÖ CONSENSUS</div>
        <div style="font-size:0.85rem;">Dual-detector (coarse + fine) is the foundation. All 3 models agree.</div>
      </div>
      <div style="background:rgba(249,115,22,0.1); border:1px solid rgba(249,115,22,0.3); border-radius:8px; padding:12px; margin-bottom:16px;">
        <div style="font-weight:600; color:var(--orange); margin-bottom:4px;">‚ö° DISAGREEMENT</div>
        <div style="font-size:0.85rem;">Dynamic k: Grok & ChatGPT say yes, Gemini says NO (curve-fitting risk on 1m data).</div>
      </div>
      <div id="councilCards"></div>
    </div>
    <div class="card">
      <h3>Key Parameters (From Council)</h3>
      <table>
        <thead><tr><th>Parameter</th><th>Grok</th><th>Gemini</th><th>ChatGPT</th><th>Status</th></tr></thead>
        <tbody>
          <tr><td>coarse_base</td><td>6.5</td><td>7.0</td><td>6.5-8.0</td><td><span class="badge badge-green">Testing</span></td></tr>
          <tr><td>fine_base</td><td>2.0</td><td>2.0</td><td>2.0</td><td><span class="badge badge-green">Agreed</span></td></tr>
          <tr><td>dynamic k</td><td>‚úÖ alpha=0.65</td><td>‚ùå static</td><td>‚úÖ gamma</td><td><span class="badge badge-gold">Phase 2</span></td></tr>
          <tr><td>fallback candles</td><td>800</td><td>600</td><td>‚Äî</td><td><span class="badge badge-blue">TBD</span></td></tr>
          <tr><td>min_leg_atr</td><td>4.0</td><td>‚Äî</td><td>‚Äî</td><td><span class="badge badge-blue">TBD</span></td></tr>
          <tr><td>scoring</td><td>‚Äî</td><td>‚Äî</td><td>prominence + geometry + recency</td><td><span class="badge badge-gold">Phase 3</span></td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// Load data
let DATA = null;
let currentTrade = 0;
let sortCol = 'within50';
let sortAsc = false;

fetch('data/pivot-lab-data.json')
  .then(r => r.json())
  .then(d => { DATA = d; init(); })
  .catch(e => document.body.innerHTML += '<p style="color:red;padding:20px;">Failed to load data: '+e+'</p>');

function init() {
  renderLeaderboard();
  renderHeatmap();
  renderTrades();
  renderRoadmap();
  renderCouncil();
  
  // Tab switching
  document.querySelectorAll('.tab').forEach(t => {
    t.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
      document.querySelectorAll('.panel').forEach(x => x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById(t.dataset.tab).classList.add('active');
    });
  });
}

function grade(diff) {
  if (diff <= 50) return { text: 'üéØ Perfect', cls: 'badge-green' };
  if (diff <= 200) return { text: '‚úÖ Good', cls: 'badge-cyan' };
  if (diff <= 500) return { text: '‚ö†Ô∏è Fair', cls: 'badge-gold' };
  return { text: '‚ùå Miss', cls: 'badge-red' };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê LEADERBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderLeaderboard() {
  const configs = [...DATA.configs];
  
  // Top stats
  const hierConfigs = configs.filter(c => c.type === 'hier');
  const best = hierConfigs.reduce((a,b) => a.within50 > b.within50 ? a : (a.within50 === b.within50 && a.avgDiff < b.avgDiff ? a : b));
  const worst = hierConfigs.reduce((a,b) => a.within50 < b.within50 ? a : b);
  
  document.getElementById('topStats').innerHTML = `
    <div class="stat-card"><div class="value" style="color:var(--gold)">${best.label}</div><div class="label">Best Hier Config (${best.within50}/41 ‚â§$50)</div></div>
    <div class="stat-card"><div class="value" style="color:var(--purple)">21/41</div><div class="label">SM Champion (best-of-10, $295 avg)</div></div>
    <div class="stat-card"><div class="value" style="color:var(--green)">${best.within50}/41</div><div class="label">Best ‚â§$50 (dual-detector)</div></div>
    <div class="stat-card"><div class="value" style="color:var(--cyan)">${hierConfigs.length}</div><div class="label">Configs Tested (Phase 1)</div></div>
  `;
  
  // Sort
  configs.sort((a,b) => {
    let av = a[sortCol], bv = b[sortCol];
    if (sortCol === 'avgDiff') return sortAsc ? av - bv : bv - av;
    return sortAsc ? av - bv : bv - av;
  });
  // For avgDiff, lower is better so reverse default
  if (sortCol === 'avgDiff' && !sortAsc) configs.reverse();
  
  const tbody = document.querySelector('#leaderTable tbody');
  tbody.innerHTML = '';
  
  // Add SM champion as reference
  const smChamp = DATA.smChampion;
  
  configs.forEach((c, i) => {
    const g = grade(c.avgDiff);
    const isChamp = c.type === 'hier' && c.within50 === best.within50 && c.avgDiff === best.avgDiff;
    const pct = Math.round((c.within50 / 41) * 100);
    const barW = pct;
    const barColor = pct >= 36 ? 'var(--green)' : pct >= 25 ? 'var(--gold)' : 'var(--red)';
    
    tbody.innerHTML += `
      <tr class="${isChamp ? 'champion' : ''}">
        <td>${i+1}</td>
        <td><strong>${c.label}</strong></td>
        <td><span class="badge ${c.type==='hier' ? 'badge-gold' : 'badge-cyan'}">${c.type==='hier' ? 'Dual' : 'Single'}</span></td>
        <td><strong>${c.within50}</strong>/41</td>
        <td>${c.within200}/41</td>
        <td>${c.within500}/41</td>
        <td>$${c.avgDiff}</td>
        <td><div style="display:flex;align-items:center;gap:6px;"><div style="width:80px;height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;"><div style="width:${barW}%;height:100%;background:${barColor};border-radius:4px;"></div></div><span style="font-size:0.75rem;color:var(--dim);">${pct}%</span></div></td>
      </tr>
    `;
  });
  
  // Sort headers
  document.querySelectorAll('#leaderTable th[data-sort]').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if (col === sortCol) sortAsc = !sortAsc;
      else { sortCol = col; sortAsc = false; }
      renderLeaderboard();
    });
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HEATMAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderHeatmap() {
  const metric = document.querySelector('input[name="hmMetric"]:checked').value;
  const hierConfigs = DATA.configs.filter(c => c.type === 'hier');
  
  const coarseVals = [...new Set(hierConfigs.map(c => c.coarse))].sort((a,b) => a-b);
  const mesoVals = [...new Set(hierConfigs.map(c => c.meso))].sort((a,b) => a-b);
  
  const lookup = {};
  hierConfigs.forEach(c => { lookup[`${c.coarse}-${c.meso}`] = c; });
  
  // Find min/max for color scale
  let vals = hierConfigs.map(c => c[metric]).filter(v => v !== undefined);
  const minV = Math.min(...vals), maxV = Math.max(...vals);
  
  const cols = mesoVals.length + 1;
  const grid = document.getElementById('heatmapGrid');
  grid.style.gridTemplateColumns = `60px repeat(${mesoVals.length}, 1fr)`;
  
  let html = '<div class="hm-label"></div>';
  mesoVals.forEach(m => { html += `<div class="hm-label">meso=${m}</div>`; });
  
  coarseVals.forEach(c => {
    html += `<div class="hm-label">c=${c}</div>`;
    mesoVals.forEach(m => {
      const cfg = lookup[`${c}-${m}`];
      if (!cfg) {
        html += `<div class="hm-cell" style="background:var(--surface2);color:var(--dim);">‚Äî</div>`;
        return;
      }
      const val = cfg[metric];
      let norm;
      if (metric === 'avgDiff') {
        norm = 1 - (val - minV) / (maxV - minV || 1); // lower is better
      } else {
        norm = (val - minV) / (maxV - minV || 1); // higher is better
      }
      const hue = Math.round(norm * 120); // 0=red, 60=yellow, 120=green
      const sat = 70 + norm * 30;
      const lum = 15 + norm * 25;
      const display = metric === 'avgDiff' ? `$${val}` : `${val}/41`;
      
      html += `<div class="hm-cell" style="background:hsl(${hue},${sat}%,${lum}%);color:${norm>0.5?'#fff':'#ccc'};" title="c${c}√óm${m}: ${display}">${display}</div>`;
    });
  });
  
  grid.innerHTML = html;
  
  // Insights
  const best = hierConfigs.reduce((a,b) => a.within50 > b.within50 ? a : (a.within50 === b.within50 && a.avgDiff < b.avgDiff ? a : b));
  const bestAvg = hierConfigs.reduce((a,b) => a.avgDiff < b.avgDiff ? a : b);
  
  document.getElementById('heatmapInsights').innerHTML = `
    <p>üèÜ <strong>Best ‚â§$50:</strong> ${best.label} with ${best.within50}/41 ($${best.avgDiff} avg)</p>
    <p>üìä <strong>Best avg diff:</strong> ${bestAvg.label} with $${bestAvg.avgDiff} avg (${bestAvg.within50}/41 ‚â§$50)</p>
    <p>üéØ <strong>SM Champion to beat:</strong> 21/41 ‚â§$50, $295 avg (mult=2.0 best-of-10)</p>
    <p>üìà <strong>Pattern:</strong> ${coarseVals.length} coarse √ó ${mesoVals.length} meso = ${hierConfigs.length} combinations tested</p>
    <p>‚ö° <strong>Gap to SM champion:</strong> ${21 - best.within50} trades behind on ‚â§$50. Phase 2 (dynamic k) should close this gap.</p>
  `;
}

document.addEventListener('change', (e) => {
  if (e.target.name === 'hmMetric') renderHeatmap();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PER-TRADE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderTrades() {
  const picker = document.getElementById('tradePicker');
  picker.innerHTML = '';
  DATA.trades.forEach((t, i) => {
    picker.innerHTML += `<option value="${i}">#${i+1} ${t.date} ${t.pair} ${t.dir} (${t.r > 0 ? '+':''}${t.r}R)</option>`;
  });
  picker.addEventListener('change', () => { currentTrade = +picker.value; renderTrade(); });
  document.getElementById('prevTrade').addEventListener('click', () => { if (currentTrade > 0) { currentTrade--; picker.value = currentTrade; renderTrade(); }});
  document.getElementById('nextTrade').addEventListener('click', () => { if (currentTrade < DATA.trades.length-1) { currentTrade++; picker.value = currentTrade; renderTrade(); }});
  renderTrade();
}

function renderTrade() {
  const t = DATA.trades[currentTrade];
  document.getElementById('tradeInfo').innerHTML = `Trade <strong>${currentTrade+1}</strong>/41`;
  
  const isShort = t.dir === 'S';
  const realLabel = isShort ? 'Real Bottom' : 'Real Top';
  const realPrice = isShort ? t.bottom : t.real_top;
  
  // Stats
  const smGrade = t.sm_diff != null ? grade(t.sm_diff) : { text: '‚Äî', cls: '' };
  const hierGrade = t.hier_anchor_diff != null ? grade(t.hier_anchor_diff) : { text: '‚Äî', cls: '' };
  
  document.getElementById('tradeStats').innerHTML = `
    <div class="stat-card"><div class="value">${t.date}</div><div class="label">${t.pair} ${t.dir === 'S' ? 'üî¥ SHORT' : 'üü¢ LONG'} @ $${t.entry.toFixed(2)}</div></div>
    <div class="stat-card"><div class="value" style="color:${t.r>0?'var(--green)':'var(--red)'}">${t.r > 0 ? '+':''}${t.r}R</div><div class="label">${t.exit_type}</div></div>
    <div class="stat-card"><div class="value">$${t.sm_diff != null ? t.sm_diff.toFixed(0) : '‚Äî'}</div><div class="label">SM Diff <span class="badge ${smGrade.cls}">${smGrade.text}</span></div></div>
    <div class="stat-card"><div class="value">$${t.hier_anchor_diff != null ? t.hier_anchor_diff.toFixed(0) : '‚Äî'}</div><div class="label">Hier Diff <span class="badge ${hierGrade.cls}">${hierGrade.text}</span></div></div>
  `;
  
  document.getElementById('tradeTitle').textContent = `Config Comparison ‚Äî ${t.pair} ${t.dir} ${t.date}`;
  
  // Bar chart ‚Äî all hier configs for this trade
  const allDiffs = t.allDiffs || {};
  const entries = Object.entries(allDiffs).sort((a,b) => a[1] - b[1]);
  const maxDiff = Math.max(...entries.map(e => e[1]), 500);
  
  let barsHtml = '';
  entries.forEach(([cfg, diff]) => {
    const pct = Math.min(100, (diff / maxDiff) * 100);
    const g = grade(diff);
    const color = diff <= 50 ? 'var(--green)' : diff <= 200 ? 'var(--cyan)' : diff <= 500 ? 'var(--gold)' : 'var(--red)';
    barsHtml += `
      <div class="bar-row">
        <div class="bar-label">${cfg}</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:${color};">${diff <= 50 ? 'üéØ' : ''}</div>
        </div>
        <div class="bar-value" style="color:${color};">$${diff.toFixed(0)}</div>
      </div>
    `;
  });
  // Add SM reference
  if (t.sm_diff != null) {
    const pct = Math.min(100, (t.sm_diff / maxDiff) * 100);
    const color = t.sm_diff <= 50 ? 'var(--green)' : t.sm_diff <= 200 ? 'var(--cyan)' : t.sm_diff <= 500 ? 'var(--gold)' : 'var(--red)';
    barsHtml += `
      <div class="bar-row" style="margin-top:8px; border-top:1px solid var(--border); padding-top:8px;">
        <div class="bar-label" style="color:var(--purple);">SM m2.0</div>
        <div class="bar-track">
          <div class="bar-fill" style="width:${pct}%;background:var(--purple);">${t.sm_diff <= 50 ? 'üéØ' : ''}</div>
        </div>
        <div class="bar-value" style="color:var(--purple);">$${t.sm_diff.toFixed(0)}</div>
      </div>
    `;
  }
  
  document.getElementById('tradeBarChart').innerHTML = barsHtml;
  
  // Table
  const tbody = document.querySelector('#tradeTable tbody');
  tbody.innerHTML = '';
  entries.forEach(([cfg, diff]) => {
    const g = grade(diff);
    // Find the corresponding config to get the extreme price
    const hierData = DATA.configs.find(c => c.type === 'hier' && c.label === cfg.replace('c','c').replace('-m','√óm'));
    tbody.innerHTML += `
      <tr>
        <td>${cfg}</td>
        <td>‚Äî</td>
        <td><strong>$${diff.toFixed(2)}</strong></td>
        <td><span class="badge ${g.cls}">${g.text}</span></td>
      </tr>
    `;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ROADMAP ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderRoadmap() {
  const phases = DATA.phases;
  const done = phases.filter(p => p.status === 'done').length;
  
  document.getElementById('roadmapStats').innerHTML = `
    <div class="stat-card"><div class="value" style="color:var(--green)">${done}/${phases.length}</div><div class="label">Phases Complete</div></div>
    <div class="stat-card"><div class="value" style="color:var(--gold)">${phases.find(p=>p.status==='now')?.name || 'None active'}</div><div class="label">Current Phase</div></div>
    <div class="stat-card"><div class="value">21/41</div><div class="label">SM Champion to Beat</div></div>
    <div class="stat-card"><div class="value" style="color:var(--cyan)">PF 2.0</div><div class="label">Ultimate Goal</div></div>
  `;
  
  const timeline = document.getElementById('phaseTimeline');
  timeline.innerHTML = '';
  phases.forEach(p => {
    timeline.innerHTML += `
      <div class="phase-item">
        <div class="phase-dot ${p.status}"></div>
        <div class="phase-name">Phase ${p.id}: ${p.name}</div>
        <div class="phase-desc">${p.desc}</div>
        <div class="phase-expected">Expected: ${p.expected}</div>
      </div>
    `;
  });
  
  // Results history
  const tbody = document.getElementById('resultsHistory');
  const results = [
    { test: 'V3 scan fix', method: 'Current engine', w50: '‚Äî', w200: '‚Äî', avg: '‚Äî', verdict: 'Works but misses wicks' },
    { test: 'SM v1', method: 'Single mult=2.0, last pivot', w50: '7/41', w200: '19/41', avg: '$550', verdict: '‚ùå Grabs noise' },
    { test: 'SM v2', method: 'Single mult=8.0, last pivot', w50: '11/41', w200: '22/41', avg: '$350', verdict: '‚ùå Better, misses 25%' },
    { test: 'SM v3 ‚≠ê', method: 'mult=2.0, best of last 10', w50: '21/41', w200: '31/41', avg: '$295', verdict: '‚≠ê SM Champion' },
    { test: 'SM v4', method: 'mult=8.0, last pivot (deployed)', w50: '15/41', w200: '25/41', avg: '$346', verdict: '‚ùå Some correct v3 missed' },
    { test: 'Hier Phase 1', method: 'Best dual-detector (grid search)', w50: '15/41', w200: '26/41', avg: '$347', verdict: 'üî® Baseline established' },
  ];
  tbody.innerHTML = '';
  results.forEach(r => {
    tbody.innerHTML += `<tr><td><strong>${r.test}</strong></td><td>${r.method}</td><td>${r.w50}</td><td>${r.w200}</td><td>${r.avg}</td><td>${r.verdict}</td></tr>`;
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AI COUNCIL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderCouncil() {
  const container = document.getElementById('councilCards');
  container.innerHTML = '';
  DATA.aiCouncil.forEach(c => {
    container.innerHTML += `
      <div class="council-card">
        <div class="council-model">${c.model}</div>
        <div class="council-core"><strong>Core:</strong> ${c.core}</div>
        <div class="council-unique"><strong>Unique:</strong> ${c.unique}</div>
      </div>
    `;
  });
}
</script>
</body>
</html>
